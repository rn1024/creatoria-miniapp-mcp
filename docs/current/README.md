# å½“å‰å¾…å®æ–½æ”¹åŠ¨æ€»è§ˆ

> æœ€åæ›´æ–°: 2025-12-27
> ç‰ˆæœ¬: 0.3.0 (è§„åˆ’ä¸­)

## æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«ä¸¤ä¸ªå¾…å®æ–½çš„æ”¹åŠ¨è®¡åˆ’ï¼š

1. **æ¶æ„è¿ç§»**ï¼šå®Œå…¨ä½¿ç”¨æ–°æ¶æ„ï¼ˆcapabilities + runtimeï¼‰
2. **æˆªå›¾ä¿®å¤**ï¼šè§£å†³æˆªå›¾è¶…æ—¶å¡ä½é—®é¢˜

---

## æ”¹åŠ¨ä¸€è§ˆ

| æ”¹åŠ¨ | ç±»å‹ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ | æ–‡æ¡£ |
|------|------|--------|---------|------|
| æ¶æ„è¿ç§» | é‡æ„ | é«˜ | 18-25h | [01-architecture-migration.md](./01-architecture-migration.md) |
| æˆªå›¾ä¿®å¤ | Bug Fix | ç´§æ€¥ | 8-9h | [02-screenshot-timeout-fix.md](./02-screenshot-timeout-fix.md) |

---

## æ”¹åŠ¨ä¸€ï¼šæ¶æ„è¿ç§»

### èƒŒæ™¯

é¡¹ç›®å½“å‰å¤„äºæ··åˆæ¶æ„çŠ¶æ€ï¼š
- è¿è¡Œæ—¶æœåŠ¡ (runtime/) å·²å®Œæˆè¿ç§»ï¼š100%
- å·¥å…·å®ç° (tools/) å®Œå…¨æœªè¿ç§»ï¼š0%
- èƒ½åŠ›æ¡†æ¶ (capabilities/) ä»…ä½œä¸ºä»£ç†ï¼š50%

### ç›®æ ‡

å°† 5,244 è¡Œå·¥å…·ä»£ç ä» `src/tools/` è¿ç§»åˆ° `src/capabilities/`ï¼Œå®ç°ï¼š
- æ¨¡å—åŒ–å·¥å…·ç»„ç»‡
- Schema é©±åŠ¨çš„è¾“å…¥éªŒè¯
- åŠ¨æ€å·¥å…·åŠ è½½
- åˆ é™¤æ—§çš„ tools/ å’Œ core/ ç›®å½•

### æ ¸å¿ƒæ”¹åŠ¨

```
å½“å‰ç»“æ„:                         ç›®æ ‡ç»“æ„:
src/                              src/
â”œâ”€â”€ tools/          âŒ 5,244è¡Œ     â”œâ”€â”€ capabilities/    ğŸ†• æ¨¡å—åŒ–
â”‚   â”œâ”€â”€ index.ts    1,645è¡Œ       â”‚   â”œâ”€â”€ automator/
â”‚   â”œâ”€â”€ automator.ts              â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ miniprogram.ts            â”‚   â”‚   â””â”€â”€ handlers/
â”‚   â””â”€â”€ ...                       â”‚   â”œâ”€â”€ miniprogram/
â”œâ”€â”€ core/           âŒ å…¼å®¹å±‚      â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ *.ts        â†’ runtime     â”‚   â”‚   â””â”€â”€ handlers/
â””â”€â”€ runtime/        âœ… ä¿æŒ       â”‚   â”œâ”€â”€ page/
                                  â”‚   â”œâ”€â”€ element/
                                  â”‚   â”œâ”€â”€ loader.ts     ğŸ†•
                                  â”‚   â””â”€â”€ registry.ts   ğŸ†•
                                  â””â”€â”€ runtime/          âœ… ä¿æŒ
```

### å·¥ä½œé‡

| é˜¶æ®µ | å†…å®¹ | é¢„è®¡æ—¶é—´ |
|------|------|---------|
| Phase 1 | åŸºç¡€è®¾æ–½ï¼ˆloader/registryï¼‰ | 3-4h |
| Phase 2 | Automator è¿ç§»ï¼ˆ4å·¥å…·ï¼‰ | 2-3h |
| Phase 3 | MiniProgram è¿ç§»ï¼ˆ6å·¥å…·ï¼‰ | 2-3h |
| Phase 4 | Page è¿ç§»ï¼ˆ8å·¥å…·ï¼‰ | 2-3h |
| Phase 5 | Element è¿ç§»ï¼ˆ23å·¥å…·ï¼‰ | 3-4h |
| Phase 6 | Assert/Snapshot/Record/Network | 4-5h |
| Phase 7 | æ¸…ç†ä¸æµ‹è¯• | 2-3h |
| **æ€»è®¡** | - | **18-25h** |

---

## æ”¹åŠ¨äºŒï¼šæˆªå›¾è¶…æ—¶ä¿®å¤

### é—®é¢˜

`miniprogram_screenshot` å·¥å…·è°ƒç”¨æ—¶ç»å¸¸å¡ä½ï¼š
- æ— è¶…æ—¶ä¿æŠ¤ï¼šPromise æ°¸ä¸ resolve/reject
- base64 è¿”å›è¢«åˆ é™¤ï¼šå¿…é¡»èµ°æ–‡ä»¶ä¿å­˜è·¯å¾„
- çº§è”å½±å“ï¼šæ‰€æœ‰ snapshot å·¥å…·éƒ½ä¼šå¡ä½

### æ ¹æœ¬åŸå› 

```typescript
// âŒ å½“å‰ä»£ç  - æ— è¶…æ—¶ä¿æŠ¤
const screenshotBuffer = await session.miniProgram.screenshot({
  path: fullPath,
  fullPage,
})

// âœ… åº”è¯¥ä½¿ç”¨ withTimeout
const screenshotBuffer = await withTimeout(
  session.miniProgram.screenshot({ ... }),
  timeoutMs,
  'Screenshot capture'
)
```

### æ ¸å¿ƒæ”¹åŠ¨

1. **P0**ï¼šä¸º screenshot æ·»åŠ  withTimeout ä¿æŠ¤
2. **P0**ï¼šæ¢å¤ returnBase64 å‚æ•°å’Œ base64 è¿”å›
3. **P1**ï¼šä¸ºå…¶ä»– miniprogram æ“ä½œæ·»åŠ è¶…æ—¶
4. **P1**ï¼šæ·»åŠ é‡è¯•æœºåˆ¶
5. **P2**ï¼šä¼˜åŒ– fullPage è¶…æ—¶é…ç½®

### å·¥ä½œé‡

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|--------|
| screenshot è¶…æ—¶ä¿æŠ¤ | 1h | P0 |
| æ¢å¤ base64 è¿”å› | 1h | P0 |
| å…¶ä»–æ“ä½œè¶…æ—¶ä¿æŠ¤ | 2h | P1 |
| é‡è¯•æœºåˆ¶ | 1.5h | P1 |
| é…ç½®ä¼˜åŒ– | 1h | P2 |
| æµ‹è¯• | 2h | P1 |
| **æ€»è®¡** | **8-9h** | - |

---

## å»ºè®®å®æ–½é¡ºåº

### æ–¹æ¡ˆ Aï¼šå…ˆä¿®å¤åè¿ç§»ï¼ˆæ¨èï¼‰

```
Week 1: æˆªå›¾ä¿®å¤ (8-9h)
  â”œâ”€ Day 1-2: P0 ä»»åŠ¡ï¼ˆè¶…æ—¶ä¿æŠ¤ + base64ï¼‰
  â””â”€ Day 3-4: P1 ä»»åŠ¡ï¼ˆå…¶ä»–è¶…æ—¶ + é‡è¯•ï¼‰

Week 2-3: æ¶æ„è¿ç§» (18-25h)
  â”œâ”€ Day 1: Phase 1ï¼ˆåŸºç¡€è®¾æ–½ï¼‰
  â”œâ”€ Day 2-3: Phase 2-4ï¼ˆæ ¸å¿ƒå·¥å…·ï¼‰
  â”œâ”€ Day 4-5: Phase 5-6ï¼ˆå‰©ä½™å·¥å…·ï¼‰
  â””â”€ Day 6: Phase 7ï¼ˆæ¸…ç†æµ‹è¯•ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- å…ˆè§£å†³ç´§æ€¥é—®é¢˜
- è¿ç§»æ—¶å¯ä»¥åŒæ—¶åº”ç”¨è¶…æ—¶ä¿æŠ¤

### æ–¹æ¡ˆ Bï¼šè¿ç§»æ—¶åŒæ­¥ä¿®å¤

```
ç›´æ¥è¿›è¡Œæ¶æ„è¿ç§»ï¼Œè¿ç§» miniprogram å·¥å…·æ—¶é¡ºå¸¦ä¿®å¤è¶…æ—¶
```

**ä¼˜åŠ¿**ï¼š
- é¿å…é‡å¤ä¿®æ”¹åŒä¸€æ–‡ä»¶
- ä»£ç åªéœ€ review ä¸€æ¬¡

**åŠ£åŠ¿**ï¼š
- ç´§æ€¥é—®é¢˜éœ€è¦ç­‰å¾…æ›´é•¿æ—¶é—´

---

## æ–‡ä»¶å˜æ›´æ±‡æ€»

### æ–°å»ºæ–‡ä»¶ï¼ˆçº¦ 40 ä¸ªï¼‰

| ç›®å½• | æ–‡ä»¶æ•° | æè¿° |
|------|--------|------|
| capabilities/*/schemas/ | ~20 | Zod schema å®šä¹‰ |
| capabilities/*/handlers/ | ~12 | å·¥å…·å¤„ç†å™¨ |
| capabilities/ | 3 | loader/registry/index |
| runtime/retry/ | 2 | é‡è¯•æœºåˆ¶ |
| tests/ | 3 | æ–°å¢æµ‹è¯• |

### ä¿®æ”¹æ–‡ä»¶ï¼ˆçº¦ 10 ä¸ªï¼‰

| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| src/server.ts | ä½¿ç”¨æ–°çš„ capabilities å…¥å£ |
| src/tools/miniprogram.ts | æ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼ˆä¸´æ—¶ï¼Œè¿ç§»ååˆ é™¤ï¼‰ |
| src/config/defaults.ts | æ–°å¢è¶…æ—¶é…ç½® |
| src/types.ts | æ›´æ–°ç±»å‹å®šä¹‰ |
| tests/**/*.test.ts | æ›´æ–°å¯¼å…¥è·¯å¾„ |

### åˆ é™¤æ–‡ä»¶ï¼ˆçº¦ 17 ä¸ªï¼‰

| ç›®å½• | æ–‡ä»¶æ•° | æè¿° |
|------|--------|------|
| src/tools/ | 9 | å…¨éƒ¨å·¥å…·æ–‡ä»¶ |
| src/core/ | 8 | å…¨éƒ¨å…¼å®¹å±‚æ–‡ä»¶ |

---

## é£é™©è¯„ä¼°

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| è¿ç§»è¿‡ç¨‹ä¸­å¼•å…¥ bug | ä¸­ | é«˜ | é€é˜¶æ®µæäº¤ï¼Œå®Œæ•´æµ‹è¯• |
| è¶…æ—¶æ—¶é—´è®¾ç½®ä¸åˆç† | ä½ | ä¸­ | é…ç½®åŒ–ï¼Œå…è®¸ç”¨æˆ·è°ƒæ•´ |
| æµ‹è¯•è¦†ç›–ä¸è¶³ | ä½ | ä¸­ | å…ˆè¡¥å……æµ‹è¯•å†è¿ç§» |
| æ–‡æ¡£ä¸åŒæ­¥ | ä½ | ä½ | åŒæ­¥æ›´æ–° README |

---

## éªŒæ”¶æ ‡å‡†

### æ¶æ„è¿ç§»

- [ ] æ‰€æœ‰ 65 ä¸ªå·¥å…·è¿ç§»åˆ° capabilities/
- [ ] tools/ å’Œ core/ ç›®å½•åˆ é™¤
- [ ] æ‰€æœ‰å·¥å…·æœ‰ Zod schema
- [ ] å•å…ƒæµ‹è¯• 100% é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] TypeScript ç¼–è¯‘æ— é”™è¯¯

### æˆªå›¾ä¿®å¤

- [ ] æˆªå›¾ 10s å†…è¿”å›æˆ–è¶…æ—¶
- [ ] fullPage æˆªå›¾ 30s å†…è¿”å›æˆ–è¶…æ—¶
- [ ] returnBase64=true æ­£ç¡®è¿”å› base64
- [ ] æ‰€æœ‰ miniprogram æ“ä½œæœ‰è¶…æ—¶ä¿æŠ¤
- [ ] è¶…æ—¶æµ‹è¯•è¦†ç›–

---

## ç›¸å…³æ–‡æ¡£

- [01-architecture-migration.md](./01-architecture-migration.md) - æ¶æ„è¿ç§»è¯¦ç»†è®¡åˆ’
- [02-screenshot-timeout-fix.md](./02-screenshot-timeout-fix.md) - æˆªå›¾ä¿®å¤è¯¦ç»†æ–¹æ¡ˆ
- [../directory-structure-and-code-style-best-practices.md](../directory-structure-and-code-style-best-practices.md) - ä»£ç è§„èŒƒ
- [../migration/](../migration/) - å†å²è¿ç§»æ–‡æ¡£
