# Charter: [B2] SessionStore å®ç°

task_id: B2
task_name: SessionStore ä¼šè¯ç®¡ç†å™¨
stage: B
phase: Align (Retrospective)
created_at: "2025-10-02"
status: COMPLETED
estimated_hours: 2-3
actual_hours: 3

## Goal (ç›®æ ‡)

å®ç°ä¼šè¯éš”ç¦»çš„ SessionStoreï¼Œç®¡ç†å¤šä¸ª MCP ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸã€èµ„æºæ¸…ç†å’Œè¶…æ—¶å›æ”¶ã€‚

**æ ¸å¿ƒäº¤ä»˜ç‰©**:
- `src/core/session.ts` (~200 lines)
- `tests/unit/session.test.ts` (93 tests)
- SessionStore ç±»ï¼šget/set/delete/dispose/getOrCreate/updateActivity
- è‡ªåŠ¨è¶…æ—¶æ¸…ç†æœºåˆ¶

## Non-Goals (éç›®æ ‡)

- âŒ ä¸å®ç°æŒä¹…åŒ–å­˜å‚¨ï¼ˆä»…å†…å­˜ï¼‰
- âŒ ä¸å®ç°ä¼šè¯å…±äº«ï¼ˆè·¨è¿›ç¨‹ï¼‰
- âŒ ä¸å®ç°ä¼šè¯è¿ç§»
- âŒ ä¸å®ç°åˆ†å¸ƒå¼é”

## Scope (èŒƒå›´)

### In Scope (åŒ…å«)

1. **SessionState æ¥å£**
   - âœ… sessionId: string
   - âœ… miniProgram: MiniProgram | null
   - âœ… ideProcess: ChildProcess | null
   - âœ… elementCache: Map<string, Element>
   - âœ… createdAt, lastActivity: Date
   - âœ… outputDir: string

2. **SessionStore ç±»**
   - âœ… get(sessionId): SessionState | undefined
   - âœ… set(sessionId, state): void
   - âœ… delete(sessionId): void
   - âœ… dispose(): Promise<void>
   - âœ… getOrCreate(sessionId): SessionState
   - âœ… updateActivity(sessionId): void

3. **è¶…æ—¶æ¸…ç†**
   - âœ… å®šæ—¶æ£€æŸ¥ä¼šè¯æ´»åŠ¨æ—¶é—´
   - âœ… è¶…æ—¶ä¼šè¯è‡ªåŠ¨æ¸…ç†
   - âœ… è°ƒç”¨ miniProgram.disconnect() å’Œ ideProcess.kill()
   - âœ… æ¸…ç†å…ƒç´ ç¼“å­˜

4. **é…ç½®é€‰é¡¹**
   - âœ… sessionTimeout: number (é»˜è®¤ 30 åˆ†é’Ÿ)
   - âœ… outputDir: string (é»˜è®¤ .mcp-artifacts)
   - âœ… cleanupInterval: number (é»˜è®¤ 60 ç§’)

5. **èµ„æºæ¸…ç†**
   - âœ… disconnect miniProgram
   - âœ… kill ideProcess
   - âœ… clear elementCache
   - âœ… æ—¥å¿—è¾“å‡ºæ¸…ç†ç»“æœ

### Out of Scope (ä¸åŒ…å«)

- âŒ æŒä¹…åŒ–åˆ°ç£ç›˜/æ•°æ®åº“
- âŒ ä¼šè¯çŠ¶æ€åºåˆ—åŒ–
- âŒ è·¨è¿›ç¨‹ä¼šè¯å…±äº«
- âŒ ä¼šè¯å¿«ç…§å’Œæ¢å¤

## Constraints (çº¦æŸ)

### Technical Constraints (æŠ€æœ¯çº¦æŸ)

1. **å†…å­˜å®‰å…¨**
   - å¿…é¡»é˜²æ­¢å†…å­˜æ³„æ¼
   - è¶…æ—¶ä¼šè¯å¿…é¡»è¢«æ¸…ç†
   - èµ„æºé‡Šæ”¾å¿…é¡»å½»åº•

2. **å¹¶å‘å®‰å…¨**
   - æ”¯æŒå¤šä¼šè¯å¹¶å‘è®¿é—®
   - Map æ“ä½œåŸå­æ€§
   - é¿å…ç«æ€æ¡ä»¶

3. **TypeScript è§„èŒƒ**
   - å®Œæ•´ç±»å‹å®šä¹‰
   - æ³›å‹çº¦æŸ
   - ä¸¥æ ¼æ¨¡å¼

4. **æµ‹è¯•è¦†ç›–**
   - å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >95%
   - 93 ä¸ªæµ‹è¯•ç”¨ä¾‹
   - è¦†ç›–æ‰€æœ‰è¾¹ç•Œæ¡ä»¶

### Business Constraints (ä¸šåŠ¡çº¦æŸ)

1. **ä¼šè¯è¶…æ—¶**: é»˜è®¤ 30 åˆ†é’Ÿ
2. **æ¸…ç†å‘¨æœŸ**: æ¯ 60 ç§’æ£€æŸ¥ä¸€æ¬¡
3. **èµ„æºé™åˆ¶**: æ”¯æŒæœ€å¤š 100 ä¸ªå¹¶å‘ä¼šè¯
4. **æ€§èƒ½è¦æ±‚**: ä¼šè¯æ“ä½œ <10ms

## Success Criteria (æˆåŠŸæ ‡å‡†)

### Functional Criteria (åŠŸèƒ½æ ‡å‡†)

- âœ… get/set/delete æ“ä½œæ­£å¸¸
- âœ… getOrCreate è‡ªåŠ¨åˆ›å»ºä¼šè¯
- âœ… updateActivity æ›´æ–°æ—¶é—´æˆ³
- âœ… è¶…æ—¶ä¼šè¯è‡ªåŠ¨æ¸…ç†
- âœ… dispose æ¸…ç†æ‰€æœ‰ä¼šè¯
- âœ… èµ„æºé‡Šæ”¾å®Œæ•´ï¼ˆminiProgram/ideProcess/cacheï¼‰

### Quality Criteria (è´¨é‡æ ‡å‡†)

- âœ… TypeScript ç¼–è¯‘ 0 é”™è¯¯
- âœ… 93 ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- âœ… ä»£ç è¦†ç›–ç‡ >95%
- âœ… æ—  ESLint é”™è¯¯
- âœ… JSDoc æ³¨é‡Šå®Œæ•´

### Documentation Criteria (æ–‡æ¡£æ ‡å‡†)

- âœ… SessionState æ¥å£æ–‡æ¡£
- âœ… SessionStore API æ–‡æ¡£
- âœ… é…ç½®é€‰é¡¹è¯´æ˜
- â³ charter.B2.align.yaml (æœ¬æ–‡æ¡£)
- â³ tasks.B2.atomize.md (ä»»åŠ¡å¡)

## Definition of Done (å®Œæˆæ ‡å‡†)

**ä»£ç **:
- âœ… `src/core/session.ts` å®ç°å®Œæˆ (~200 lines)
- âœ… TypeScript ç¼–è¯‘é€šè¿‡
- âœ… æ‰€æœ‰å…¬å…±æ–¹æ³•å®ç°

**æµ‹è¯•**:
- âœ… `tests/unit/session.test.ts` (93 tests)
- âœ… è¦†ç›–æ‰€æœ‰æ–¹æ³•
- âœ… æµ‹è¯•è¶…æ—¶æ¸…ç†é€»è¾‘
- âœ… æµ‹è¯•èµ„æºé‡Šæ”¾

**æ–‡æ¡£**:
- â³ charter.B2.align.yaml (è¿½æº¯)
- â³ tasks.B2.atomize.md (è¿½æº¯)
- â³ session_log (è¿½æº¯)

**Git**:
- âœ… å·²æäº¤ï¼ˆéš A2-B1-B2 ä¿®å¤æäº¤ï¼‰

## Dependencies (ä¾èµ–)

**å‰ç½®ä»»åŠ¡**:
- âœ… A3: ä»“åº“ç»“æ„åˆå§‹åŒ–
- âœ… TypeScript é…ç½®å®Œæˆ

**åç»­ä»»åŠ¡**:
- B2 â†’ B1 (Server ä¾èµ– SessionStore)
- B2 â†’ C1-C4 (å·¥å…·éœ€è¦ä¼šè¯ç®¡ç†)

## Risks (é£é™©)

### Technical Risks (æŠ€æœ¯é£é™©)

1. **å†…å­˜æ³„æ¼** - ğŸŸ¢ å·²ç¼“è§£
   - å½±å“ï¼šé•¿æ—¶é—´è¿è¡Œå†…å­˜æº¢å‡º
   - ç¼“è§£ï¼šå®šæ—¶æ¸…ç† + dispose æœºåˆ¶

2. **èµ„æºæ³„æ¼** - ğŸŸ¢ å·²ç¼“è§£
   - å½±å“ï¼šè¿›ç¨‹/è¿æ¥æœªå…³é—­
   - ç¼“è§£ï¼šå®Œæ•´çš„æ¸…ç†æµç¨‹ + æµ‹è¯•éªŒè¯

3. **å¹¶å‘é—®é¢˜** - ğŸŸ¢ ä½é£é™©
   - å½±å“ï¼šç«æ€æ¡ä»¶å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
   - ç¼“è§£ï¼šMap åŸå­æ“ä½œï¼Œç®€å•é”æœºåˆ¶

### Business Risks (ä¸šåŠ¡é£é™©)

1. **è¶…æ—¶é…ç½®ä¸å½“** - ğŸŸ¡ ä¸­é£é™©
   - å½±å“ï¼šä¼šè¯è¿‡æ—©æ¸…ç†æˆ–å†…å­˜å ç”¨è¿‡é«˜
   - ç¼“è§£ï¼šå¯é…ç½®è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼ç»è¿‡æµ‹è¯•

## Open Questions (æœªå†³é—®é¢˜)

- âœ… ä¼šè¯è¶…æ—¶æ—¶é—´è®¾ç½®ä¸ºå¤šå°‘åˆé€‚ï¼Ÿï¼ˆå·²ç¡®å®šï¼š30 åˆ†é’Ÿï¼‰
- âœ… æ˜¯å¦éœ€è¦ä¼šè¯æŒä¹…åŒ–ï¼Ÿï¼ˆå¦ï¼Œä»…å†…å­˜å­˜å‚¨ï¼‰
- â“ æ˜¯å¦éœ€è¦æ”¯æŒä¼šè¯ä¼˜å…ˆçº§ï¼Ÿï¼ˆå½“å‰æ— ï¼‰

## References (å‚è€ƒèµ„æ–™)

- `docs/å®Œæ•´å®ç°æ–¹æ¡ˆ.md` - ä¼šè¯ç®¡ç†æ¶æ„
- `src/types.ts` - SessionState æ¥å£å®šä¹‰
- Node.js ChildProcess API æ–‡æ¡£

---

**Approval**: âœ… RETROSPECTIVE APPROVED
**Implementation**: âœ… COMPLETED
**Documentation**: â³ IN PROGRESS
