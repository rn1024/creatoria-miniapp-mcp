# Charter: [C4] Element 工具完整实现

task_id: C4
task_name: Element 工具完整实现（23个工具 + 子类操作）
stage: C
phase: Align (Retrospective)
created_at: "2025-10-02"
status: COMPLETED
estimated_hours: 6-8
actual_hours: 8

## Goal (目标)

实现 Element 级别的完整工具集，包括 23 个核心交互工具和 6 类专用组件操作，覆盖点击、长按、触摸事件、属性读取、输入、滑动、移动等所有元素操作。

**核心交付物**:
- `src/tools/element.ts` - 23 个工具 + 子类操作 (956 lines)
- `tests/unit/element.test.ts` - 单元测试 (1104 lines, 72 tests)
- 工具分类:
  - **交互操作** (7个): tap, longpress, touchstart, touchmove, touchend, input, trigger
  - **属性读取** (6个): getText, getAttribute, getValue, getProperty, getStyle, getComputedStyle
  - **位置尺寸** (3个): getSize, getOffset, getBoundingClientRect
  - **移动滑动** (3个): swipe, moveTo, scrollTo
  - **子类操作** (6类): Input, Textarea, Picker, ScrollView, Swiper, MovableView

## Non-Goals (非目标)

- ❌ 不实现断言工具（留给 Stage D）
- ❌ 不实现录制功能（留给 Stage F）
- ❌ 不实现元素截图（属于 Page 级别）
- ❌ 不实现拖拽到其他元素（简化实现）

## Scope (范围)

### In Scope (包含)

#### 1. 基础交互 (7个工具)

- ✅ **tap**: 点击元素
- ✅ **longpress**: 长按元素（350ms）
- ✅ **touchstart**: 触摸开始事件
- ✅ **touchmove**: 触摸移动事件
- ✅ **touchend**: 触摸结束事件
- ✅ **input**: 输入文本
- ✅ **trigger**: 触发自定义事件

#### 2. 属性读取 (6个工具)

- ✅ **getText**: 获取元素文本内容
- ✅ **getAttribute**: 获取元素属性（支持 data-* 属性）
- ✅ **getValue**: 获取表单元素值
- ✅ **getProperty**: 获取元素属性（JavaScript 属性）
- ✅ **getStyle**: 获取元素样式
- ✅ **getComputedStyle**: 获取计算后样式

#### 3. 位置尺寸 (3个工具)

- ✅ **getSize**: 获取元素尺寸（width, height）
- ✅ **getOffset**: 获取元素偏移（left, top）
- ✅ **getBoundingClientRect**: 获取完整边界信息

#### 4. 移动滑动 (3个工具)

- ✅ **swipe**: 滑动元素（支持方向和距离）
- ✅ **moveTo**: 移动到指定位置
- ✅ **scrollTo**: 滚动到指定位置

#### 5. 专用组件操作 (6类子类工具)

**Input / Textarea**:
- ✅ input_input: 输入文本
- ✅ input_clear: 清空内容
- ✅ input_getValue: 获取值
- ✅ input_focus: 聚焦
- ✅ input_blur: 失焦

**Picker**:
- ✅ picker_select: 选择选项（支持索引/值）
- ✅ picker_getValue: 获取当前值
- ✅ picker_getRange: 获取选项列表

**ScrollView**:
- ✅ scrollview_scrollTo: 滚动到位置
- ✅ scrollview_scrollIntoView: 滚动到子元素
- ✅ scrollview_getScrollOffset: 获取滚动偏移

**Swiper**:
- ✅ swiper_swipeTo: 滑动到指定页
- ✅ swiper_next: 下一页
- ✅ swiper_prev: 上一页
- ✅ swiper_getCurrent: 获取当前页索引

**MovableView**:
- ✅ movable_moveTo: 移动到位置
- ✅ movable_getPosition: 获取当前位置

#### 6. ElementRef 集成

- ✅ 所有工具支持 ElementRef 协议
- ✅ 支持 refId/selector/xpath 三种查询方式
- ✅ 统一的元素解析逻辑

### Out of Scope (不包含)

- ❌ 元素截图（使用 Page screenshot）
- ❌ 拖拽到其他元素（使用 touchstart + touchmove + touchend 组合）
- ❌ 复杂手势识别（缩放、旋转等）
- ❌ 动画状态检测

## Constraints (约束)

### Technical Constraints (技术约束)

1. **miniprogram-automator 依赖**
   - 使用 Element 实例的官方 API
   - 遵循触摸事件坐标系统
   - 正确处理异步操作

2. **触摸事件坐标**
   - pageX/pageY: 相对于页面的坐标
   - clientX/clientY: 相对于视口的坐标
   - 支持多点触摸（touches 数组）

3. **长按时间**
   - 默认: 350ms
   - 符合微信小程序标准

4. **子类组件约束**
   - Picker: 仅支持 selector/multiSelector/time/date 模式
   - ScrollView: 支持横向/纵向滚动
   - Swiper: 支持循环/自动播放配置
   - MovableView: 支持边界限制

### Business Constraints (业务约束)

1. **交互时间**: 单次操作 <1 秒
2. **长按时间**: 350ms（固定）
3. **滑动时间**: 可配置，默认 300ms
4. **兼容性**: 支持所有微信小程序基础组件

## Success Criteria (成功标准)

### Functional Criteria (功能标准)

**基础交互**:
- ✅ tap 触发点击事件
- ✅ longpress 触发长按事件
- ✅ touchstart/move/end 支持触摸事件序列
- ✅ input 输入文本到表单元素
- ✅ trigger 触发自定义事件

**属性读取**:
- ✅ getText 获取文本内容
- ✅ getAttribute 获取 HTML 属性
- ✅ getValue 获取表单值
- ✅ getProperty 获取 JavaScript 属性
- ✅ getStyle/getComputedStyle 获取样式

**位置尺寸**:
- ✅ getSize 返回宽高
- ✅ getOffset 返回偏移
- ✅ getBoundingClientRect 返回完整边界

**移动滑动**:
- ✅ swipe 支持 4 个方向滑动
- ✅ moveTo 移动到指定坐标
- ✅ scrollTo 滚动到位置

**子类操作**:
- ✅ Input/Textarea 输入操作完整
- ✅ Picker 选择操作完整
- ✅ ScrollView 滚动操作完整
- ✅ Swiper 翻页操作完整
- ✅ MovableView 移动操作完整

### Quality Criteria (质量标准)

- ✅ TypeScript 编译 0 错误
- ✅ 单元测试覆盖率 >85%
- ✅ 72 个测试用例全部通过
- ✅ 无 ESLint 错误
- ✅ JSDoc 注释完整（956 行代码）

### Documentation Criteria (文档标准)

- ✅ 每个工具有详细 schema 定义
- ✅ 子类操作分类清晰
- ✅ 坐标系统文档完整
- ⏳ charter.C4.align.yaml (本文档)
- ⏳ tasks.C4.atomize.md (任务卡)

## Definition of Done (完成标准)

**代码**:
- ✅ `src/tools/element.ts` 实现完成 (956 lines)
- ✅ TypeScript 编译通过
- ✅ 23 个核心工具 + 6 类子类操作正确注册

**测试**:
- ✅ `tests/unit/element.test.ts` (1104 lines)
- ✅ 72 个测试用例全部通过
- ✅ 覆盖所有工具和子类操作
- ✅ Mock Element 实例

**文档**:
- ⏳ charter.C4.align.yaml (追溯)
- ⏳ tasks.C4.atomize.md (追溯)
- ✅ README 工具列表更新

**Git**:
- ✅ 已提交（Stage C 提交）

## Dependencies (依赖)

**前置任务**:
- ✅ C3: Page 工具（query 获取元素）
- ✅ ElementRef 协议实现
- ✅ B2: SessionStore（管理元素缓存）

**后续任务**:
- C4 → C5 (工具注册器集成)
- C4 → D1 (Assert 工具使用 Element 属性)

## Risks (风险)

### Technical Risks (技术风险)

1. **触摸事件复杂性** - 🟡 中风险
   - 影响：多点触摸和事件序列可能出错
   - 缓解：完整的单元测试覆盖

2. **子类组件兼容性** - 🟡 中风险
   - 影响：不同组件可能有特殊行为
   - 缓解：参考官方文档实现

3. **坐标系统混淆** - 🟢 已缓解
   - 风险：pageX 和 clientX 混用
   - 缓解：统一使用 pageX/pageY

### Business Risks (业务风险)

1. **性能问题** - 🟢 已缓解
   - 影响：大量元素操作可能影响性能
   - 缓解：使用元素缓存优化

## Open Questions (未决问题)

- ❓ 是否需要支持拖拽到其他元素？（当前使用触摸事件组合）
- ❓ 是否需要支持复杂手势（缩放、旋转）？（当前不支持）
- ❓ 是否需要支持动画状态检测？（当前不支持）

## References (参考资料)

- `docs/微信小程序自动化完整操作手册.md` - Element API 文档
- `docs/完整实现方案.md` - 工具分层设计
- `miniprogram-automator` 官方文档
- 微信小程序组件文档

---

**Approval**: ✅ RETROSPECTIVE APPROVED
**Implementation**: ✅ COMPLETED (23个工具 + 6类子类操作)
**Documentation**: ⏳ IN PROGRESS
