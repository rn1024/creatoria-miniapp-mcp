# Charter: [C5] å·¥å…·æ³¨å†Œå™¨

task_id: C5
task_name: å·¥å…·æ³¨å†Œå™¨å®ç°ï¼ˆregisterTools å‡½æ•° + å…ƒæ•°æ®ç³»ç»Ÿï¼‰
stage: C
phase: Align (Retrospective)
created_at: "2025-10-02"
status: COMPLETED
estimated_hours: 3-4
actual_hours: 4

## Goal (ç›®æ ‡)

å®ç°ç»Ÿä¸€çš„å·¥å…·æ³¨å†Œç³»ç»Ÿï¼ŒæŒ‰ capabilities åŠ¨æ€æ³¨å†Œå·¥å…·ï¼Œæä¾›å·¥å…·åˆ†ç±»ã€å…ƒæ•°æ®ç®¡ç†å’ŒéªŒè¯æœºåˆ¶ã€‚

**æ ¸å¿ƒäº¤ä»˜ç‰©**:
- `src/tools/index.ts` - registerTools å‡½æ•° + å…ƒæ•°æ®ç³»ç»Ÿ (1433 lines)
- `tests/unit/tool-registration.test.ts` - å•å…ƒæµ‹è¯• (400 lines, 46 tests)
- åŠŸèƒ½:
  - registerTools(server, context) å‡½æ•°
  - 6 ä¸ªå·¥å…·åˆ†ç±»ç³»ç»Ÿï¼ˆAUTOMATOR, MINIPROGRAM, PAGE, ELEMENT, ASSERT, SNAPSHOTï¼‰
  - TOOL_CATEGORIES å…ƒæ•°æ®ï¼ˆå·¥å…·åˆ†ç±»ã€æè¿°ã€æ•°é‡ç»Ÿè®¡ï¼‰
  - Capabilities è¿‡æ»¤æœºåˆ¶
  - Schema éªŒè¯å’Œ handler ç»‘å®š

## Non-Goals (éç›®æ ‡)

- âŒ ä¸å®ç°å·¥å…·çš„å…·ä½“é€»è¾‘ï¼ˆç”± C1-C4 å®Œæˆï¼‰
- âŒ ä¸å®ç°åŠ¨æ€å·¥å…·åŠ è½½ï¼ˆé™æ€æ³¨å†Œï¼‰
- âŒ ä¸å®ç°å·¥å…·ç‰ˆæœ¬ç®¡ç†
- âŒ ä¸å®ç°å·¥å…·æƒé™æ§åˆ¶

## Scope (èŒƒå›´)

### In Scope (åŒ…å«)

1. **registerTools å‡½æ•°**
   - âœ… æ¥æ”¶ MCP Server å®ä¾‹
   - âœ… æ¥æ”¶ ToolContextï¼ˆgetSession, deleteSession å›è°ƒï¼‰
   - âœ… æ ¹æ® capabilities è¿‡æ»¤å·¥å…·
   - âœ… æ‰¹é‡æ³¨å†Œå·¥å…·åˆ° Server
   - âœ… è¿”å›å·²æ³¨å†Œå·¥å…·åˆ—è¡¨

2. **å·¥å…·åˆ†ç±»ç³»ç»Ÿ**
   - âœ… AUTOMATOR_TOOLS: 4 ä¸ªå·¥å…·ï¼ˆlaunch, connect, disconnect, closeï¼‰
   - âœ… MINIPROGRAM_TOOLS: 6 ä¸ªå·¥å…·ï¼ˆnavigate, callWx, evaluate, screenshot, getPageStack, getSystemInfoï¼‰
   - âœ… PAGE_TOOLS: 8 ä¸ªå·¥å…·ï¼ˆquery, queryAll, waitFor, getData, setData, callMethod, getSize, getScrollTopï¼‰
   - âœ… ELEMENT_TOOLS: 23 ä¸ªæ ¸å¿ƒå·¥å…· + å­ç±»æ“ä½œ
   - âœ… ASSERT_TOOLS: æ–­è¨€å·¥å…·ï¼ˆStage Dï¼‰
   - âœ… SNAPSHOT_TOOLS: å¿«ç…§å·¥å…·ï¼ˆStage Dï¼‰

3. **TOOL_CATEGORIES å…ƒæ•°æ®**
   - âœ… å·¥å…·åˆ†ç±»åç§°å’Œæè¿°
   - âœ… æ¯ä¸ªåˆ†ç±»åŒ…å«çš„å·¥å…·åˆ—è¡¨
   - âœ… å·¥å…·æ•°é‡ç»Ÿè®¡
   - âœ… Capability æ˜ å°„å…³ç³»

4. **Capabilities è¿‡æ»¤**
   - âœ… æ”¯æŒ 'core'ï¼ˆAutomator + MiniProgram + Page + Elementï¼‰
   - âœ… æ”¯æŒ 'assert'ï¼ˆAssert å·¥å…·ï¼‰
   - âœ… æ”¯æŒ 'snapshot'ï¼ˆSnapshot å·¥å…·ï¼‰
   - âœ… æ”¯æŒ 'record'ï¼ˆRecord å·¥å…·ï¼‰
   - âœ… æ”¯æŒ 'network'ï¼ˆNetwork Mock å·¥å…·ï¼‰
   - âœ… æ”¯æŒ 'tracing'ï¼ˆTracing å·¥å…·ï¼‰
   - âœ… æ”¯æŒç»„åˆ capabilities

5. **å·¥å…·éªŒè¯**
   - âœ… Schema å®šä¹‰éªŒè¯
   - âœ… Handler å‡½æ•°å­˜åœ¨æ€§æ£€æŸ¥
   - âœ… å·¥å…·åç§°å”¯ä¸€æ€§æ£€æŸ¥
   - âœ… é”™è¯¯æ—¥å¿—å’Œå¼‚å¸¸å¤„ç†

6. **ToolContext æ¥å£**
   - âœ… getSession(sessionId): Session
   - âœ… deleteSession(sessionId): void
   - âœ… ä¼ é€’ç»™æ‰€æœ‰å·¥å…· handler

### Out of Scope (ä¸åŒ…å«)

- âŒ å·¥å…·å…·ä½“å®ç°ï¼ˆC1-C4ï¼‰
- âŒ åŠ¨æ€å·¥å…·åŠ è½½
- âŒ å·¥å…·ç‰ˆæœ¬ç®¡ç†
- âŒ å·¥å…·æƒé™æ§åˆ¶
- âŒ å·¥å…·ä½¿ç”¨ç»Ÿè®¡

## Constraints (çº¦æŸ)

### Technical Constraints (æŠ€æœ¯çº¦æŸ)

1. **MCP SDK å…¼å®¹**
   - ä½¿ç”¨ Server.setRequestHandler(CallToolRequestSchema, ...)
   - éµå¾ª MCP å·¥å…·å®šä¹‰è§„èŒƒ
   - æ­£ç¡®è¿”å›å·¥å…·åˆ—è¡¨å’Œæ‰§è¡Œç»“æœ

2. **å·¥å…·å‘½åè§„èŒƒ**
   - æ ¼å¼: `miniapp_{level}_{action}`
   - ç¤ºä¾‹: `miniapp_automator_launch`, `miniapp_element_tap`
   - å…¨å±€å”¯ä¸€æ€§

3. **Capabilities æ˜ å°„**
   - core: Automator + MiniProgram + Page + Element
   - assert: Assert å·¥å…·
   - snapshot: Snapshot å·¥å…·
   - record: Record å·¥å…·
   - network: Network Mock å·¥å…·
   - tracing: Tracing å·¥å…·

4. **ToolContext ä¾èµ–æ³¨å…¥**
   - é€šè¿‡å‚æ•°ä¼ é€’ getSession/deleteSession
   - é¿å…å…¨å±€çŠ¶æ€
   - ä¾¿äºæµ‹è¯•å’Œæ‰©å±•

### Business Constraints (ä¸šåŠ¡çº¦æŸ)

1. **æ³¨å†Œæ—¶é—´**: <100ms
2. **å·¥å…·æ€»æ•°**: å½“å‰ ~60 ä¸ªå·¥å…·ï¼ˆcore + assert + snapshotï¼‰
3. **å†…å­˜å ç”¨**: æ³¨å†Œå <10MB

## Success Criteria (æˆåŠŸæ ‡å‡†)

### Functional Criteria (åŠŸèƒ½æ ‡å‡†)

- âœ… registerTools æ­£ç¡®æ³¨å†Œå·¥å…·
- âœ… capabilities è¿‡æ»¤æ­£ç¡®
- âœ… å·¥å…· handler æ­£ç¡®ç»‘å®š
- âœ… schema éªŒè¯é€šè¿‡
- âœ… è¿”å›æ­£ç¡®çš„å·¥å…·åˆ—è¡¨
- âœ… TOOL_CATEGORIES å…ƒæ•°æ®å®Œæ•´

### Quality Criteria (è´¨é‡æ ‡å‡†)

- âœ… TypeScript ç¼–è¯‘ 0 é”™è¯¯
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >80%
- âœ… 46 ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- âœ… æ—  ESLint é”™è¯¯
- âœ… JSDoc æ³¨é‡Šå®Œæ•´

### Documentation Criteria (æ–‡æ¡£æ ‡å‡†)

- âœ… registerTools å‡½æ•°æœ‰è¯¦ç»†æ³¨é‡Š
- âœ… TOOL_CATEGORIES æœ‰æ¸…æ™°è¯´æ˜
- âœ… Capabilities æ˜ å°„æ–‡æ¡£å®Œæ•´
- â³ charter.C5.align.yaml (æœ¬æ–‡æ¡£)
- â³ tasks.C5.atomize.md (ä»»åŠ¡å¡)

## Definition of Done (å®Œæˆæ ‡å‡†)

**ä»£ç **:
- âœ… `src/tools/index.ts` å®ç°å®Œæˆ (1433 lines)
- âœ… TypeScript ç¼–è¯‘é€šè¿‡
- âœ… registerTools å‡½æ•°æ­£ç¡®å·¥ä½œ

**æµ‹è¯•**:
- âœ… `tests/unit/tool-registration.test.ts` (400 lines)
- âœ… 46 ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- âœ… è¦†ç›–æ‰€æœ‰ capabilities ç»„åˆ
- âœ… Mock Server å’Œ Context

**æ–‡æ¡£**:
- â³ charter.C5.align.yaml (è¿½æº¯)
- â³ tasks.C5.atomize.md (è¿½æº¯)
- âœ… README å·¥å…·åˆ—è¡¨æ›´æ–°

**Git**:
- âœ… å·²æäº¤ï¼ˆStage C æäº¤ï¼‰

## Dependencies (ä¾èµ–)

**å‰ç½®ä»»åŠ¡**:
- âœ… C1: Automator å·¥å…·
- âœ… C2: MiniProgram å·¥å…·
- âœ… C3: Page å·¥å…·
- âœ… C4: Element å·¥å…·
- âœ… B1: MCP Server éª¨æ¶

**åç»­ä»»åŠ¡**:
- C5 â†’ E3 (CLI ä¼ é€’ capabilities å‚æ•°)
- C5 â†’ D1 (Assert å·¥å…·æ³¨å†Œ)
- C5 â†’ D2 (Snapshot å·¥å…·æ³¨å†Œ)

## Risks (é£é™©)

### Technical Risks (æŠ€æœ¯é£é™©)

1. **å·¥å…·æ•°é‡å¢é•¿** - ğŸŸ¡ ä¸­é£é™©
   - å½±å“ï¼šå·¥å…·è¿‡å¤šå¯èƒ½å½±å“æ€§èƒ½
   - ç¼“è§£ï¼šæŒ‰ capabilities åˆ†ç»„åŠ è½½

2. **å‘½åå†²çª** - ğŸŸ¢ å·²ç¼“è§£
   - é£é™©ï¼šå·¥å…·åç§°é‡å¤
   - ç¼“è§£ï¼šæ³¨å†Œæ—¶æ£€æŸ¥å”¯ä¸€æ€§

3. **Schema éªŒè¯å¤±è´¥** - ğŸŸ¢ å·²ç¼“è§£
   - é£é™©ï¼šSchema å®šä¹‰é”™è¯¯å¯¼è‡´æ³¨å†Œå¤±è´¥
   - ç¼“è§£ï¼šå•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰å·¥å…·

### Business Risks (ä¸šåŠ¡é£é™©)

1. **æ³¨å†Œæ—¶é—´è¿‡é•¿** - ğŸŸ¢ å·²ç¼“è§£
   - å½±å“ï¼šå¯åŠ¨æ…¢
   - ç¼“è§£ï¼šä¼˜åŒ–æ³¨å†Œé€»è¾‘ï¼Œ<100ms

## Open Questions (æœªå†³é—®é¢˜)

- â“ æ˜¯å¦éœ€è¦æ”¯æŒåŠ¨æ€å·¥å…·åŠ è½½ï¼Ÿï¼ˆå½“å‰é™æ€æ³¨å†Œï¼‰
- â“ æ˜¯å¦éœ€è¦å·¥å…·ç‰ˆæœ¬ç®¡ç†ï¼Ÿï¼ˆå½“å‰æ— ç‰ˆæœ¬ï¼‰
- â“ æ˜¯å¦éœ€è¦å·¥å…·ä½¿ç”¨ç»Ÿè®¡ï¼Ÿï¼ˆå½“å‰ä¸æ”¶é›†ï¼‰

## References (å‚è€ƒèµ„æ–™)

- `docs/å®Œæ•´å®ç°æ–¹æ¡ˆ.md` - å·¥å…·åˆ†å±‚è®¾è®¡
- `docs/å¾®ä¿¡å°ç¨‹åºè‡ªåŠ¨åŒ–å®Œæ•´æ“ä½œæ‰‹å†Œ.md` - å®Œæ•´ API å‚è€ƒ
- `@modelcontextprotocol/sdk` æ–‡æ¡£
- C1-C4 ä»»åŠ¡æ–‡æ¡£

---

**Approval**: âœ… RETROSPECTIVE APPROVED
**Implementation**: âœ… COMPLETED (1433 lines + 46 tests)
**Documentation**: â³ IN PROGRESS
