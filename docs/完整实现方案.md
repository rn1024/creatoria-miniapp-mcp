# 微信小程序 MCP 自动化服务完整实现方案

## 1. 背景与目标
- 将微信官方自动化 SDK（`miniprogram-automator`）包装为符合 Model Context Protocol (MCP) 的服务，供各类 LLM / Agent 以自然语言编排端到端测试与运维流程。
- 参考 `playwright-mcp` 的成熟实践，形成工具粒度清晰、配置灵活、可观测性良好的工程体系。
- 保持与需求文档、《微信小程序自动化 API 完整文档》一致的能力覆盖，同时吸收 Playwright MCP 的上下文管理、能力开关、自动文档等工程手段。

## 2. 总体架构
```
[LLM Host / IDE / Agent] ⇄ MCP Transport (stdio / SSE / HTTP)
        │
        ▼
[MCP Server: miniprogram-mcp]
        │  ├─ 工具 (Tools) Registry & Schema
        │  ├─ Session / Context Store
        │  └─ Output 管理 (日志 / 截图 / 数据快照)
        ▼
[微信开发者工具 CLI] ⇄ [miniprogram-automator]
        │
        ▼
[本地小程序项目]
```
- MCP Server 负责解析工具调用、维护会话状态、调度 `miniprogram-automator` 与 IDE 自动化端口。
- 会话上下文仿照 Playwright MCP：懒加载启动 IDE、持有 MiniProgram/Page/Element 句柄、统一回收资源。
- 支持多 Host 并发接入，通过 MCP sessionId 隔离状态。

## 3. MCP 服务设计
### 3.1 运行流程
1. Host 建立 MCP 连接（默认 stdio，可选 HTTP 端口模式）。
2. `launch`/`connect` 工具唤起开发者工具 CLI，创建 `MiniProgram` 句柄并缓存至 `SessionStore`。
3. 之后的工具调用显式传参（pagePath、selector、refId 等），服务端根据 ElementRef 解析具体对象并执行 automator API。
4. 每次调用输出结构化结果（状态、数据、产物路径），可选附带审计信息（日志、截图、页面数据）。

### 3.2 Session / Context 管理
- `SessionState` (per MCP session)：
  - `miniProgram`: automator 返回的实例。
  - `ideProcess`: CLI 进程/端口信息。
  - `pages`: 已打开页面堆栈。
  - `elements`: refId → Element 缓存（页面切换后自动失效）。
  - `outputs`: 当次会话的截图/数据快照目录。
- 生命周期：首次请求创建，`miniProgram.close` 或会话断开时释放；异常时触发兜底清理。
- 参考 Playwright 的 Context：加入 `outputFile()`、`log()`、`lookupSecret()` 等辅助方法以统一产物写入和敏感信息保护。

### 3.3 工具体系
- **Automator 级**：`launch`、`connect`、`disconnect`、`close`。
- **MiniProgram 级**：导航（`navigate_to`/`redirect_to`/`switch_tab`/...）、系统信息、`call_wx_method`、`mock_wx_method`、`evaluate`、`screenshot`、`page_scroll_to`、`test_accounts` 等。
- **Page 级**：`wait_for`、`query`/`query_all`、`xpath` 系列、`data`/`set_data`、`call_method`、`size`、`scroll_top`。
- **Element 级**：`text`、`attribute`、`value`、`property`、`style`、`tap`、`longpress`、`trigger`、`touch*`、子类专属（`input`、`scroll_to`、`swipe_to`、`move_to`、`slider_slide_to`、`context_call`、`custom_set_data` 等）。
- **扩展工具**（对标 Playwright capabilities）：
  - `snapshot_page`（结构化 DOM 报文）；
  0  `assert` 系列（exists/text/data 等）；
  - `record_actions` / `replay_actions`；
  - `storage_get/set/clear`；
  - `network_mock`（基于 `mockWxMethod` 或注入脚本）；
  - `capture_artifacts`（一次性导出截图 + 页面数据）。
- 工具定义：使用 `zod` 构建 schema，统一注册到 `McpServer`，同时驱动 README/文档自动生成（借鉴 `update-readme.js` 的生成逻辑）。

### 3.4 ElementRef 协议
```ts
type ElementRef = {
  refId?: string;          // 已知句柄
  selector?: string;       // WXML/CSS 选择器
  xpath?: string;          // XPath 选择器
  index?: number;          // 多元素选择时的下标
  pagePath?: string;       // 指定页面
  save?: boolean;          // 是否缓存句柄并返回新 refId
};
```
- 优先级：`refId` > `xpath` > `selector`；若页面刷新导致失效，自动抛错并提示重新查询。
- 解析成功后按需缓存，类似 Playwright 的 `Tab` 对象管理。

## 4. API 映射策略
- 对照《微信小程序自动化 API 完整文档》，确保 MiniProgram/Page/Element 方法全部可通过工具触达。
- 未覆盖场景（如自定义函数调用、复杂数据注入）通过 `evaluate`、`expose_function`、`call_wx_method` 提供兜底能力。
- 断言与快照基于页面数据 (`page.data`) 与元素属性构建，兼容 wx 数据绑定场景。

## 5. 配置体系
### 5.1 配置来源
1. **CLI 参数**（与 Playwright 对齐）：项目路径、CLI 路径、自动化端口、headless、输出目录、超时、能力开关等。
2. **配置文件**：JSON/TS（通过 `--config` 指定），可嵌套定义项目列表、默认页面、Mock 脚本、Secrets。
3. **环境变量**：用于注入敏感信息（token、账号），配合 `lookupSecret` 管理。

### 5.2 优先级与解析
- 实现 `resolveConfig`: 默认配置 ← 配置文件 ← 环境变量 ← CLI Overrides。
- 默认配置示例：
  - `project.projectPath`: 当前工作目录。
  - `timeouts`: action=5s / navigation=30s。
  - `outputDir`: `.mcp-artifacts/{session}`。
  - `capabilities`: `['core']`。
- 支持多项目：`projects[].name + projectPath + custom launch options`，LLM 可通过 `launch` 的 `project` 字段选择。

### 5.3 能力开关 (Capabilities)
| Capability | 说明 | 依赖 |
|------------|------|------|
| `core` | 基础导航、查询、交互工具 | 必选 |
| `assert` | 启用断言工具 | 数据比对模块 |
| `snapshot` | 页面结构化快照 + 截图 | `snapshot_page`、`capture_artifacts` |
| `record` | 录制/回放工具 | Action Recorder 存储 |
| `network` | `mock_wx`、`mock_plugin_wx` 扩展 | 注入脚本/Mock 配置 |
| `tracing` | 每会话生成行为日志（对应 Playwright trace 思路） | 输出目录 |
| `vision` | 未来支持坐标/截图分析（可选） | 视觉模型/IDE 截图 |

## 6. 输出与观测
- **日志**：
  - 控制台输出结构化 JSON（tool、duration、result），便于 Host 呈现。
  - 可选写入 `session.log`，仿照 Playwright 的 `SessionLog`。
- **产物**：
  - 截图：`miniProgram.screenshot`；失败时自动抓取。
  - 页面数据快照：`page.data()` + 元素树；断言失败时附带 diff。
  - 动作录制：按工具调用序列生成 JSON。
- **统计**：收集工具耗时、失败率，通过 CLI 参数启用。

## 7. 开发与测试流程
1. **环境准备**：安装微信开发者工具、开启 CLI/HTTP 调用；安装 Node 18+；`npm i` 安装依赖。
2. **本地开发**：
   - `npm run dev` 使用 ts-node 运行；
   - 可通过 MCP Inspector / Claude Desktop 连接测试。
3. **自动化测试**：
   - 单元：针对 ElementRef 解析、配置解析编写 Jest/TS 测试。
   - 集成：使用示例小程序项目 + CI Runner（macOS/Windows）跑回归脚本。
   - 参考 Playwright 的 `playwright test` 实践，构建 `tests/` 用例驱动 CLI。
4. **CI/CD**：
   - 采用 GitHub Actions/Moore pipeline：
     1. 安装依赖与微信 IDE（或缓存）；
     2. 启动虚拟 display（macOS Runner 不需要 xvfb）；
     3. 执行自动化脚本；
     4. 上传日志/截图/快照为工件。
   - 发布：`npm publish` 前运行 `npm run roll` 同步类型与文档。

## 8. 安全与稳定
- 限制工具对文件系统操作：`outputDir` 白名单。
- 针对 `evaluate/inject` 建立白名单或沙箱，避免越权访问宿主机。
- 会话超时与 watchdog：长期未活动自动关闭 IDE。
- 断言/操作前增加 `page.waitFor`/`wait_for_selector`，减少竞态失败。

## 9. 与 Playwright MCP 的对齐点
- **工具 Schema 自动生成文档**：实现 `docs/update-readme.ts`，遍历工具注册，输出参数说明。
- **能力分层**：使用 `capabilities` 控制高级功能开启，与 CLI `--caps` 对齐。
- **上下文复用**：提供 `sharedMiniProgram` 模式，支持多个会话共享 IDE（类似 `SharedContextFactory`）。
- **产物输出**：仿照 trace/video，提供统一的 `artifacts/` 目录结构：`screenshots/`、`snapshots/`、`actions.json`。

## 10. 交付物与后续路线
- **最小可用版本 (MVP)**：
  - 实现 `core` 能力工具集；
  - 支持 CLI 启动 + 配置文件；
  - 提供示例脚本与使用文档。
- **增强路线**：
  1. 断言 DSL / 测试报告可视化；
  2. 多端兼容（真机云测、远程调试接入）；
  3. 与团队测试平台集成（结果上报、用例管理）；
  4. 选择器智能推荐（结合页面结构快照与静态标记 `data-testid`）；
  5. 结合 Playwright Vision 能力扩展到混合 H5 场景。

---
该方案汇总了需求文档的能力诉求、API 覆盖范围，以及 Playwright MCP 的工程实现方式，可作为后续开发与评审的基准文档。
