# Charter: [B3] ElementRef è§£æå™¨

task_id: B3
task_name: ElementRef ç»Ÿä¸€å…ƒç´ å®šä½åè®®
stage: B
phase: Align (Retrospective)
created_at: "2025-10-02"
status: COMPLETED
estimated_hours: 2
actual_hours: 2

## Goal (ç›®æ ‡)

å®ç° ElementRef ç»Ÿä¸€å…ƒç´ å®šä½åè®®ï¼Œæ”¯æŒ refId/selector/xpath/index/pagePath å¤šç§å®šä½æ–¹å¼ï¼Œå¹¶æä¾›è‡ªåŠ¨ç¼“å­˜å’Œå¤±æ•ˆæœºåˆ¶ã€‚

**æ ¸å¿ƒäº¤ä»˜ç‰©**:
- `src/core/element-ref.ts` (~150 lines)
- resolveElement() å‡½æ•°
- resolvePage() å‡½æ•°
- generateRefId() å‡½æ•°
- å…ƒç´ ç¼“å­˜ç®¡ç†

## Non-Goals (éç›®æ ‡)

- âŒ ä¸æ”¯æŒ XPath å®šä½ï¼ˆminiprogram-automator ä¸æ”¯æŒï¼‰
- âŒ ä¸å®ç°å…ƒç´ ç­‰å¾…é€»è¾‘ï¼ˆå±äºå·¥å…·å±‚ï¼‰
- âŒ ä¸å®ç°å…ƒç´ æŸ¥è¯¢ä¼˜åŒ–ï¼ˆç›´æ¥ä½¿ç”¨ SDKï¼‰
- âŒ ä¸å®ç°è·¨é¡µé¢å…ƒç´ å¼•ç”¨

## Scope (èŒƒå›´)

### In Scope (åŒ…å«)

1. **ElementRef æ¥å£**
   - âœ… refId?: string - ç¼“å­˜å¥æŸ„å¼•ç”¨
   - âœ… selector?: string - WXML/CSS é€‰æ‹©å™¨
   - âœ… xpath?: string - XPath é€‰æ‹©å™¨ï¼ˆæŠ›å‡ºä¸æ”¯æŒé”™è¯¯ï¼‰
   - âœ… index?: number - å¤šå…ƒç´ ç´¢å¼•
   - âœ… pagePath?: string - ç›®æ ‡é¡µé¢è·¯å¾„
   - âœ… save?: boolean - æ˜¯å¦ç¼“å­˜å¹¶è¿”å› refId

2. **resolveElement() å‡½æ•°**
   - âœ… ä¼˜å…ˆä» elementCache è§£æ refId
   - âœ… è‹¥æ—  refIdï¼Œä½¿ç”¨ selector/xpath æŸ¥è¯¢
   - âœ… æ”¯æŒ index ç´¢å¼•å¤šå…ƒç´ 
   - âœ… æ”¯æŒ save å‚æ•°ç¼“å­˜å…ƒç´ 
   - âœ… è¿”å› Element å¯¹è±¡å’Œæ–° refIdï¼ˆå¦‚æœ save=trueï¼‰

3. **resolvePage() å‡½æ•°**
   - âœ… è‹¥æä¾› pagePathï¼Œåˆ‡æ¢åˆ°æŒ‡å®šé¡µé¢
   - âœ… è‹¥æ—  pagePathï¼Œè¿”å›å½“å‰é¡µé¢
   - âœ… æ”¯æŒ pagePath æ ¼å¼éªŒè¯
   - âœ… è¿”å› Page å¯¹è±¡

4. **generateRefId() å‡½æ•°**
   - âœ… ç”Ÿæˆå”¯ä¸€å…ƒç´ å¼•ç”¨ ID
   - âœ… æ ¼å¼ï¼š`elem-{timestamp}-{random}`
   - âœ… ä¿è¯å…¨å±€å”¯ä¸€æ€§

5. **ç¼“å­˜ç®¡ç†**
   - âœ… ä½¿ç”¨ session.elementCache å­˜å‚¨
   - âœ… è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶ï¼ˆé¡µé¢åˆ‡æ¢æ—¶æ¸…ç©ºï¼‰
   - âœ… æ‰‹åŠ¨æ¸…ç†æ¥å£

### Out of Scope (ä¸åŒ…å«)

- âŒ XPath æŸ¥è¯¢å®ç°
- âŒ å…ƒç´ ç­‰å¾…å’Œé‡è¯•
- âŒ å…ƒç´ æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
- âŒ è·¨ä¼šè¯å…ƒç´ å…±äº«

## Constraints (çº¦æŸ)

### Technical Constraints (æŠ€æœ¯çº¦æŸ)

1. **miniprogram-automator é™åˆ¶**
   - ä»…æ”¯æŒ CSS é€‰æ‹©å™¨å’Œç»„ä»¶é€‰æ‹©å™¨
   - ä¸æ”¯æŒ XPath
   - å…ƒç´ å¥æŸ„æ— æ³•è·¨é¡µé¢ä½¿ç”¨

2. **ç¼“å­˜å¤±æ•ˆè§„åˆ™**
   - é¡µé¢åˆ‡æ¢æ—¶è‡ªåŠ¨æ¸…ç©ºç¼“å­˜
   - å…ƒç´ é”€æ¯æ—¶å¥æŸ„å¤±æ•ˆ
   - å¿…é¡»å¤„ç†å¤±æ•ˆåœºæ™¯

3. **TypeScript è§„èŒƒ**
   - å®Œæ•´ç±»å‹å®šä¹‰
   - ä¸¥æ ¼æ¨¡å¼
   - å¯¼å…¥ä½¿ç”¨ .js åç¼€

4. **é”™è¯¯å¤„ç†**
   - æ˜ç¡®çš„é”™è¯¯æ¶ˆæ¯
   - åŒºåˆ†ä¸åŒå¤±è´¥åŸå› 
   - æä¾›è°ƒè¯•ä¿¡æ¯

### Business Constraints (ä¸šåŠ¡çº¦æŸ)

1. **æ€§èƒ½è¦æ±‚**: å…ƒç´ è§£æ <50ms
2. **ç¼“å­˜å®¹é‡**: å•ä¼šè¯æœ€å¤š 1000 ä¸ªå…ƒç´ 
3. **å…¼å®¹æ€§**: æ”¯æŒæ‰€æœ‰ WXML ç»„ä»¶

## Success Criteria (æˆåŠŸæ ‡å‡†)

### Functional Criteria (åŠŸèƒ½æ ‡å‡†)

- âœ… resolveElement æ­£ç¡®è§£æ refId
- âœ… resolveElement æ­£ç¡®è§£æ selector
- âœ… resolveElement æ”¯æŒ index ç´¢å¼•
- âœ… resolveElement æ”¯æŒ save ç¼“å­˜
- âœ… resolvePage æ­£ç¡®åˆ‡æ¢é¡µé¢
- âœ… resolvePage è¿”å›å½“å‰é¡µé¢
- âœ… generateRefId ç”Ÿæˆå”¯ä¸€ ID
- âœ… XPath æŠ›å‡ºæ˜ç¡®é”™è¯¯

### Quality Criteria (è´¨é‡æ ‡å‡†)

- âœ… TypeScript ç¼–è¯‘ 0 é”™è¯¯
- âœ… ä»£ç è¡Œæ•° ~150 è¡Œ
- âœ… æ—  ESLint é”™è¯¯
- âœ… JSDoc æ³¨é‡Šå®Œæ•´
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ï¼ˆéšå·¥å…·æµ‹è¯•ï¼‰

### Documentation Criteria (æ–‡æ¡£æ ‡å‡†)

- âœ… ElementRef æ¥å£æ–‡æ¡£
- âœ… resolveElement/resolvePage å‡½æ•°æ–‡æ¡£
- âœ… ç¼“å­˜æœºåˆ¶è¯´æ˜
- â³ charter.B3.align.yaml (æœ¬æ–‡æ¡£)
- â³ tasks.B3.atomize.md (ä»»åŠ¡å¡)

## Definition of Done (å®Œæˆæ ‡å‡†)

**ä»£ç **:
- âœ… `src/core/element-ref.ts` å®ç°å®Œæˆ (~150 lines)
- âœ… TypeScript ç¼–è¯‘é€šè¿‡
- âœ… æ‰€æœ‰å‡½æ•°å®ç°

**æµ‹è¯•**:
- âœ… å•å…ƒæµ‹è¯•éšå·¥å…·æµ‹è¯•éªŒè¯
- âœ… é›†æˆæµ‹è¯•è¦†ç›–å„ç§å®šä½æ–¹å¼
- âœ… æµ‹è¯•ç¼“å­˜å’Œå¤±æ•ˆæœºåˆ¶

**æ–‡æ¡£**:
- â³ charter.B3.align.yaml (è¿½æº¯)
- â³ tasks.B3.atomize.md (è¿½æº¯)
- â³ session_log (è¿½æº¯)

**Git**:
- âœ… å·²æäº¤ï¼ˆéš C4 Element å·¥å…·æäº¤ï¼‰

## Dependencies (ä¾èµ–)

**å‰ç½®ä»»åŠ¡**:
- âœ… A3: ä»“åº“ç»“æ„åˆå§‹åŒ–
- âœ… B2: SessionStoreï¼ˆä½¿ç”¨ elementCacheï¼‰
- âœ… miniprogram-automator SDK äº†è§£

**åç»­ä»»åŠ¡**:
- B3 â†’ C4 (Element å·¥å…·ä½¿ç”¨è§£æå™¨)
- B3 â†’ æ‰€æœ‰å…ƒç´ æ“ä½œå·¥å…·

## Risks (é£é™©)

### Technical Risks (æŠ€æœ¯é£é™©)

1. **XPath ä¸æ”¯æŒ** - ğŸŸ¢ å·²ç¼“è§£
   - å½±å“ï¼šç”¨æˆ·æœŸæœ›ä½¿ç”¨ XPath
   - ç¼“è§£ï¼šæ˜ç¡®é”™è¯¯æ¶ˆæ¯ï¼Œå¼•å¯¼ä½¿ç”¨ selector

2. **ç¼“å­˜å¤±æ•ˆ** - ğŸŸ¢ å·²ç¼“è§£
   - å½±å“ï¼šé¡µé¢åˆ‡æ¢åå…ƒç´ å¥æŸ„å¤±æ•ˆ
   - ç¼“è§£ï¼šè‡ªåŠ¨æ¸…ç©ºç¼“å­˜ï¼Œæ¸…æ™°é”™è¯¯æç¤º

3. **é€‰æ‹©å™¨å†²çª** - ğŸŸ¡ ä¸­é£é™©
   - å½±å“ï¼šselector åŒ¹é…å¤šä¸ªå…ƒç´ 
   - ç¼“è§£ï¼šæ”¯æŒ index å‚æ•°ç²¾ç¡®å®šä½

### Business Risks (ä¸šåŠ¡é£é™©)

1. **ç”¨æˆ·ä½“éªŒ** - ğŸŸ¢ ä½é£é™©
   - å½±å“ï¼šç¼“å­˜å¤±æ•ˆå¯¼è‡´æ“ä½œå¤±è´¥
   - ç¼“è§£ï¼šæ¸…æ™°é”™è¯¯æ¶ˆæ¯ï¼Œå¼•å¯¼é‡æ–°æŸ¥è¯¢

## Open Questions (æœªå†³é—®é¢˜)

- âœ… æ˜¯å¦æ”¯æŒ XPathï¼Ÿï¼ˆå¦ï¼ŒSDK ä¸æ”¯æŒï¼‰
- âœ… ç¼“å­˜å®¹é‡é™åˆ¶ï¼Ÿï¼ˆ1000 ä¸ªå…ƒç´ /ä¼šè¯ï¼‰
- â“ æ˜¯å¦éœ€è¦æ”¯æŒè·¨é¡µé¢å…ƒç´ å¼•ç”¨ï¼Ÿï¼ˆå½“å‰ä¸æ”¯æŒï¼‰

## References (å‚è€ƒèµ„æ–™)

- `docs/å¾®ä¿¡å°ç¨‹åºè‡ªåŠ¨åŒ–å®Œæ•´æ“ä½œæ‰‹å†Œ.md` - å…ƒç´ æŸ¥è¯¢ API
- `docs/å®Œæ•´å®ç°æ–¹æ¡ˆ.md` - ElementRef åè®®è®¾è®¡
- miniprogram-automator é€‰æ‹©å™¨æ–‡æ¡£

---

**Approval**: âœ… RETROSPECTIVE APPROVED
**Implementation**: âœ… COMPLETED
**Documentation**: â³ IN PROGRESS
