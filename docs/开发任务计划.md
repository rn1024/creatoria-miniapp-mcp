# 微信小程序 MCP 实现任务拆解与计划

## 阶段划分总览
1. **环境与基础设施准备**（Stage A）
2. **核心框架搭建**（Stage B）
3. **核心工具实现**（Stage C）
4. **高级能力与能力开关**（Stage D）
5. **配置体系与 CLI 集成**（Stage E）
6. **可观测性与产物输出**（Stage F）
7. **测试验证与示例沉淀**（Stage G）
8. **发布与维护流程**（Stage H）

每个阶段的任务相互依赖：Stage A → B → C → D/E → F → G → H。可在资源许可时并行推进部分子任务（例如 Stage D 与 E）。

---

## Stage A：环境与基础设施准备
| 编号 | 子任务 | 产出 | 依赖 |
|------|--------|------|------|
| A1 | 安装 Node 18+、微信开发者工具 CLI、miniprogram-automator 示例项目 | 已配置的开发环境说明 | - |
| A2 | 配置 IDE 自动化端口（CLI/HTTP）并编写启动脚本 | `scripts/launch-wx-devtool.sh` / 指南文档 | A1 |
| A3 | 建立基础目录结构（`src/`, `docs/`, `tests/`, `examples/`）与 TypeScript 工程 | 初始仓库结构、`tsconfig.json`, `package.json` | A1 |
| A4 | 搭建 lint / format / commit hooks（可选） | ESLint/Prettier 配置 | A3 |

## Stage B：核心框架搭建
| 编号 | 子任务 | 产出 | 依赖 |
|------|--------|------|------|
| B1 | 实现 MCP Server 启动骨架：`McpServer` + `StdioServerTransport` | `src/server.ts` 可运行 | A3 |
| B2 | Session 管理：`SessionStore`、上下文生命周期、资源清理 | `src/session.ts` | B1 |
| B3 | ElementRef 解析器定义与缓存机制 | `src/elementResolver.ts` | B2 |
| B4 | 输出/日志接口定义（供后续阶段使用） | `src/logger.ts`, `src/output.ts` | B2 |

## Stage C：核心工具实现
| 编号 | 子任务 | 产出 | 依赖 |
|------|--------|------|------|
| C1 | Automator 级工具：`launch`、`connect`、`disconnect`、`close` | `src/tools/automator.ts` | B1 |
| C2 | MiniProgram 级工具（导航、callWx、evaluate、screenshot 等） | `src/tools/miniProgram.ts` | C1 |
| C3 | Page 级工具（wait/query/xpath/data 等） | `src/tools/page.ts` | C2 |
| C4 | Element 级工具（属性/交互/子类方法） | `src/tools/element.ts` | C3 |
| C5 | 工具注册器：统一加载 Zod schema、生成工具列表 | `src/tools/index.ts` | C1–C4 |

## Stage D：高级能力与能力开关
| 编号 | 子任务 | 产出 | 依赖 |
|------|--------|------|------|
| D1 | 断言工具集（`assert.exists/text/data`） | `src/tools/assert.ts` | C2–C4 |
| D2 | 快照能力：页面结构化数据 + 截图封装 | `src/tools/snapshot.ts`, 产物目录结构 | B4,C2 |
| D3 | 录制/回放与动作序列管理 | `src/tools/record.ts` | B4,C2 |
| D4 | 网络 Mock / wx.request 注入工具 | `src/tools/network.ts` | C2 |
| D5 | Capabilities 机制：解析 `--caps`、按能力注册工具 | `src/capabilities.ts` | B1, C5 |

## Stage E：配置体系与 CLI 集成
| 编号 | 子任务 | 产出 | 依赖 |
|------|--------|------|------|
| E1 | 默认配置定义 + config schema | `src/config/defaults.ts` | B2 |
| E2 | `resolveConfig`：合并配置文件、环境变量、CLI 参数 | `src/config/loader.ts` | E1 |
| E3 | CLI 接入（命令行选项解析、帮助信息） | `src/cli.ts` | E2 |
| E4 | 配置文件模板与示例（JSON / YAML / TOML 自选） | `/examples/config/` | E2 |

## Stage F：可观测性与产物输出
| 编号 | 子任务 | 产出 | 依赖 |
|------|--------|------|------|
| F1 | 结构化日志（tool、耗时、状态） + 控制台输出格式化 | `src/logger.ts` 实现 | B4 |
| F2 | 失败时自动收集的截图/数据快照 | 与 D2 协作，产物写入 `artifacts/` | D2 |
| F3 | 会话报告（可选）：生成 JSON/Markdown 汇总 | `artifacts/report.json` | F1,F2 |

## Stage G：测试验证与示例沉淀
| 编号 | 子任务 | 产出 | 依赖 |
|------|--------|------|------|
| G1 | 单元测试：配置解析、ElementRef、工具入参校验 | `tests/unit/**` | B3,E2 |
| G2 | 集成测试：针对示例小程序跑端到端流程（登录/下单等） | `tests/integration/**` | C1–C4 |
| G3 | 示例脚本与文档：`examples/`、MCP 客户端使用手册 | `docs/使用指南.md`、脚本 | C1–C5 |
| G4 | 自动生成工具清单（仿 `update-readme.js`）并更新 README | `scripts/update-readme.ts` | C5,D5 |

## Stage H：发布与维护流程
| 编号 | 子任务 | 产出 | 依赖 |
|------|--------|------|------|
| H1 | CI/CD 流程：GitHub Actions 配置、IDE 安装、测试流水线 | `.github/workflows/*.yml` | A4,G1,G2 |
| H2 | 版本管理与发布脚本（`npm version`、`npm publish`） | `scripts/release.ts` 或文档 | H1 |
| H3 | 维护计划：issue 模板、版本路线图、风险登记 | `docs/roadmap.md`, `.github/ISSUE_TEMPLATE` | G4,H1 |

---

## 关键里程碑
| 里程碑 | 完成标准 | 涉及任务 |
|---------|-----------|-----------|
| M1：基础可运行 | Stage B + C1 完成；可 launch/connect 小程序并执行简单操作 | B1–B4, C1 |
| M2：核心工具完善 | MiniProgram/Page/Element 工具可用，支持基础断言 | C1–C4, D1 |
| M3：高级能力上线 | Capabilities、快照、录制、配置文件、日志体系完备 | D1–D5, E1–E4, F1–F2 |
| M4：质量验收 | 测试通过、示例脚本覆盖主流程、文档齐备 | G1–G4 |
| M5：发布就绪 | CI/CD、发布脚本上线，生成首次版本 | H1–H3 |

---

## 风险与缓解措施
- **IDE 兼容性/稳定性**：及时跟踪微信开发者工具版本更新；准备至少一个稳定版本镜像。
- **自动化端口失效**：实现重试与连通性检查；提供诊断工具（CLI 命令）。
- **元素句柄失效**：ElementRef 解析加入报错提示与重查策略。
- **CI 环境支持度**：优先在 macOS Runner 验证，如需 Windows/Linux，提供文档说明及备用脚本。
- **安全问题**：限制 `evaluate/inject` 的可用范围；将敏感凭证放入 secrets 管理。

---

## 建议的推进节奏（示例）
- 周 1–2：完成 Stage A/B；输出 MVP 骨架。
- 周 3–4：实现 Stage C 主体；交付 M1/M2。
- 周 5–6：并行推进 Stage D/E + F；完成高级能力与配置体系。
- 周 7：集中测试与文档（Stage G），达成 M4。
- 周 8：建立 CI/CD 并正式发布（Stage H），进入维护阶段。

以上计划可根据团队人力与优先级动态调整。EOF
