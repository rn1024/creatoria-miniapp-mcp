# Charter: [D2] å¿«ç…§å·¥å…·é›†

task_id: D2
task_name: å¿«ç…§å·¥å…·é›†å®ç°
stage: D
phase: Align (Retrospective)
created_at: "2025-10-02"
status: COMPLETED
estimated_hours: 2-3
actual_hours: 2

## Goal (ç›®æ ‡)

å®ç°å®Œæ•´çš„å¿«ç…§å·¥å…·é›†ï¼Œä¸ºå°ç¨‹åºè‡ªåŠ¨åŒ–æµ‹è¯•æä¾›çŠ¶æ€æ•è·å’Œå›æº¯èƒ½åŠ›ã€‚

**æ ¸å¿ƒäº¤ä»˜ç‰©**:
- `src/tools/snapshot.ts` - 3 ä¸ªå¿«ç…§å·¥å…·å®ç° (352 lines)
- `tests/unit/snapshot.test.ts` - å•å…ƒæµ‹è¯• (251 lines, 10 tests)
- å·¥å…·: snapshotPage, snapshotFull, snapshotElement

## Non-Goals (éç›®æ ‡)

- âŒ ä¸å®ç°å¿«ç…§æ¯”å¯¹ï¼ˆdiffï¼‰åŠŸèƒ½
- âŒ ä¸å®ç°å¿«ç…§å›æ”¾ï¼ˆrestoreï¼‰åŠŸèƒ½
- âŒ ä¸å®ç°å¿«ç…§å‹ç¼©/å½’æ¡£ï¼ˆä»…åŸå§‹ JSON + PNGï¼‰
- âŒ ä¸å®ç°å¤šå¿«ç…§ç®¡ç†ï¼ˆä»…å•æ¬¡æ•è·ï¼‰

## Scope (èŒƒå›´)

### In Scope (åŒ…å«)

1. **snapshotPage - é¡µé¢å¿«ç…§**
   - âœ… æ•è·å½“å‰é¡µé¢æ•°æ®ï¼ˆdata + queryï¼‰
   - âœ… å¯é€‰æˆªå›¾ï¼ˆPNG æ ¼å¼ï¼‰
   - âœ… ä¿å­˜ä¸º JSON + å¯é€‰ PNG
   - âœ… è¿”å›æ–‡ä»¶è·¯å¾„

2. **snapshotFull - å®Œæ•´åº”ç”¨å¿«ç…§**
   - âœ… æ•è·ç³»ç»Ÿä¿¡æ¯ï¼ˆsystemInfoï¼‰
   - âœ… æ•è·é¡µé¢æ ˆï¼ˆpageStackï¼‰
   - âœ… æ•è·å½“å‰é¡µé¢æ•°æ®
   - âœ… å¯é€‰æˆªå›¾ï¼ˆPNG æ ¼å¼ï¼‰
   - âœ… ä¿å­˜ä¸º JSON + å¯é€‰ PNG

3. **snapshotElement - å…ƒç´ å¿«ç…§**
   - âœ… æ•è·å…ƒç´ æ–‡æœ¬ï¼ˆtextï¼‰
   - âœ… æ•è·å…ƒç´ å°ºå¯¸ï¼ˆsizeï¼‰
   - âœ… æ•è·å…ƒç´ ä½ç½®ï¼ˆoffsetï¼‰
   - âœ… å¯é€‰æˆªå›¾ï¼ˆPNG æ ¼å¼ï¼‰
   - âœ… ä¿å­˜ä¸º JSON + å¯é€‰ PNG

4. **é€šç”¨åŠŸèƒ½**
   - âœ… è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶åï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
   - âœ… æ”¯æŒè‡ªå®šä¹‰æ–‡ä»¶å
   - âœ… ä½¿ç”¨ OutputManager ç®¡ç†æ–‡ä»¶
   - âœ… æ—¶é—´æˆ³è®°å½•ï¼ˆISO8601 æ ¼å¼ï¼‰

### Out of Scope (ä¸åŒ…å«)

- âŒ å¿«ç…§æ¯”å¯¹ï¼ˆdiffï¼‰
- âŒ å¿«ç…§æ¢å¤ï¼ˆrestoreï¼‰
- âŒ å¿«ç…§ç‰ˆæœ¬æ§åˆ¶ï¼ˆgit-likeï¼‰
- âŒ å¿«ç…§å‹ç¼©ï¼ˆzip/tarï¼‰

## Constraints (çº¦æŸ)

### Technical Constraints (æŠ€æœ¯çº¦æŸ)

1. **å·¥å…·ä¾èµ–**
   - å¤ç”¨ MiniProgram å·¥å…·ï¼ˆgetPageStack, getSystemInfo, screenshotï¼‰
   - å¤ç”¨ Page å·¥å…·ï¼ˆgetDataï¼‰
   - å¤ç”¨ Element å·¥å…·ï¼ˆgetText, getSize, getOffsetï¼‰
   - ä½¿ç”¨ OutputManager ç®¡ç†æ–‡ä»¶è¾“å‡º

2. **æ–‡ä»¶æ ¼å¼**
   - JSON: ç»“æ„åŒ–æ•°æ®ï¼ŒåŒ…å«æ—¶é—´æˆ³
   - PNG: æˆªå›¾æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
   - æ–‡ä»¶å‘½å: `snapshot-{timestamp}.json` æˆ–è‡ªå®šä¹‰

3. **æ•°æ®ç»“æ„**
   - **snapshotPage**:
     ```typescript
     {
       timestamp: string          // ISO8601
       pagePath: string           // å½“å‰é¡µé¢è·¯å¾„
       pageData: any              // é¡µé¢ data
       pageQuery: Record<string, any>  // é¡µé¢ query
     }
     ```
   - **snapshotFull**:
     ```typescript
     {
       timestamp: string
       systemInfo: any            // ç³»ç»Ÿä¿¡æ¯
       pageStack: Array<{path, query}>  // é¡µé¢æ ˆ
       currentPage: {
         path: string
         query: Record<string, any>
         data: any
       }
     }
     ```
   - **snapshotElement**:
     ```typescript
     {
       timestamp: string
       refId: string
       text?: string
       attributes: Record<string, any>
       size: {width, height} | null
       offset: {left, top} | null
     }
     ```

4. **è¿”å›å€¼ç»“æ„**
   ```typescript
   {
     success: boolean
     message: string
     snapshotPath: string         // JSON æ–‡ä»¶è·¯å¾„
     screenshotPath?: string      // PNG æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
     data: {/* å¿«ç…§æ•°æ® */}
   }
   ```

### Business Constraints (ä¸šåŠ¡çº¦æŸ)

1. **æ‰§è¡Œæ—¶é—´**: å•æ¬¡å¿«ç…§ <2sï¼ˆå«æˆªå›¾ï¼‰
2. **æ–‡ä»¶å¤§å°**: JSON <1MB, PNG <5MB
3. **å­˜å‚¨ä½ç½®**: é»˜è®¤ `outputDir`ï¼Œå¯é…ç½®

## Success Criteria (æˆåŠŸæ ‡å‡†)

### Functional Criteria (åŠŸèƒ½æ ‡å‡†)

- âœ… snapshotPage æ­£ç¡®æ•è·é¡µé¢æ•°æ®å’Œæˆªå›¾
- âœ… snapshotFull æ­£ç¡®æ•è·åº”ç”¨å…¨å±€çŠ¶æ€
- âœ… snapshotElement æ­£ç¡®æ•è·å…ƒç´ çŠ¶æ€
- âœ… JSON æ–‡ä»¶åŒ…å«å®Œæ•´æ•°æ®å’Œæ—¶é—´æˆ³
- âœ… æˆªå›¾å¯é€‰ï¼ˆincludeScreenshot å‚æ•°ï¼‰
- âœ… æ”¯æŒè‡ªå®šä¹‰æ–‡ä»¶å
- âœ… æ–‡ä»¶ä¿å­˜åˆ°æ­£ç¡®è·¯å¾„

### Quality Criteria (è´¨é‡æ ‡å‡†)

- âœ… TypeScript ç¼–è¯‘ 0 é”™è¯¯
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >80%
- âœ… 10 ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- âœ… æ—  ESLint é”™è¯¯
- âœ… JSDoc æ³¨é‡Šå®Œæ•´

### Documentation Criteria (æ–‡æ¡£æ ‡å‡†)

- âœ… æ¯ä¸ªå·¥å…·æœ‰å‡½æ•°ç­¾åå’Œ JSDoc
- âœ… æ•°æ®ç»“æ„å®šä¹‰æ¸…æ™°
- â³ charter.D2.align.yaml (æœ¬æ–‡æ¡£)
- â³ tasks.D2.atomize.md (ä»»åŠ¡å¡)

## Definition of Done (å®Œæˆæ ‡å‡†)

**ä»£ç **:
- âœ… `src/tools/snapshot.ts` å®ç°å®Œæˆ (352 lines)
- âœ… 3 ä¸ªå¿«ç…§å·¥å…·å…¨éƒ¨å®ç°
- âœ… TypeScript ç¼–è¯‘é€šè¿‡

**æµ‹è¯•**:
- âœ… `tests/unit/snapshot.test.ts` (251 lines)
- âœ… 10 ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- âœ… è¦†ç›–æˆåŠŸå’Œå¤±è´¥åœºæ™¯
- âœ… Mock miniprogram/page/element å·¥å…·ä¾èµ–

**æ–‡æ¡£**:
- â³ charter.D2.align.yaml (è¿½æº¯)
- â³ tasks.D2.atomize.md (è¿½æº¯)
- âœ… ä»£ç æ³¨é‡Šå®Œæ•´

**Git**:
- âœ… å·²æäº¤ï¼ˆcommit: feat: [D2] å¿«ç…§èƒ½åŠ›å®ç°ï¼‰

## Dependencies (ä¾èµ–)

**å‰ç½®ä»»åŠ¡**:
- âœ… C2: MiniProgram å·¥å…·ï¼ˆgetPageStack, getSystemInfo, screenshotï¼‰
- âœ… C3: Page å·¥å…·ï¼ˆgetDataï¼‰
- âœ… C4: Element å·¥å…·ï¼ˆgetText, getSize, getOffsetï¼‰
- âœ… B3: OutputManager å®ç°

**åç»­ä»»åŠ¡**:
- D2 â†’ Stage E (é›†æˆåˆ°å·¥å…·æ³¨å†Œå™¨)
- D2 â†’ Stage F (ç«¯åˆ°ç«¯æµ‹è¯•ç¤ºä¾‹)

## Risks (é£é™©)

### Technical Risks (æŠ€æœ¯é£é™©)

1. **å¤§æ•°æ®é‡å¿«ç…§** - ğŸŸ¡ ä¸­é£é™©
   - å½±å“ï¼šé¡µé¢æ•°æ®è¿‡å¤§å¯¼è‡´ JSON æ–‡ä»¶å·¨å¤§
   - ç¼“è§£ï¼šå½“å‰æ— é™åˆ¶ï¼Œæœªæ¥å¯æ·»åŠ å¤§å°è­¦å‘Š

2. **æˆªå›¾å¤±è´¥** - ğŸŸ¢ å·²ç¼“è§£
   - é£é™©ï¼šæˆªå›¾å·¥å…·å¤±è´¥å¯¼è‡´å¿«ç…§å¤±è´¥
   - ç¼“è§£ï¼šæˆªå›¾ä¸ºå¯é€‰ï¼ˆincludeScreenshot: false å¯è·³è¿‡ï¼‰

3. **æ–‡ä»¶åå†²çª** - ğŸŸ¢ å·²ç¼“è§£
   - é£é™©ï¼šæ—¶é—´æˆ³ç›¸åŒå¯¼è‡´æ–‡ä»¶è¦†ç›–
   - ç¼“è§£ï¼šOutputManager ä½¿ç”¨ `Date.now()` ç²¾ç¡®åˆ°æ¯«ç§’

### Business Risks (ä¸šåŠ¡é£é™©)

1. **å­˜å‚¨ç©ºé—´** - ğŸŸ¡ ä¸­é£é™©
   - å½±å“ï¼šå¤§é‡å¿«ç…§å ç”¨ç£ç›˜ç©ºé—´
   - ç¼“è§£ï¼šç”¨æˆ·è‡ªè¡Œç®¡ç† outputDir æ¸…ç†

## Open Questions (æœªå†³é—®é¢˜)

- â“ æ˜¯å¦éœ€è¦å¿«ç…§å‹ç¼©ï¼ˆzipï¼‰ä»¥èŠ‚çœç©ºé—´ï¼Ÿï¼ˆå½“å‰åŸå§‹æ–‡ä»¶ï¼‰
- â“ æ˜¯å¦éœ€è¦å¿«ç…§æ¯”å¯¹åŠŸèƒ½ï¼Ÿï¼ˆå½“å‰ä»…æ•è·ï¼‰
- â“ æ˜¯å¦éœ€è¦å¿«ç…§æ¢å¤åŠŸèƒ½ï¼Ÿï¼ˆå½“å‰ä»…åªè¯»ï¼‰
- â“ æ˜¯å¦éœ€è¦é™åˆ¶å•ä¸ªå¿«ç…§æ–‡ä»¶å¤§å°ï¼Ÿï¼ˆå½“å‰æ— é™åˆ¶ï¼‰

## References (å‚è€ƒèµ„æ–™)

- `docs/å®Œæ•´å®ç°æ–¹æ¡ˆ.md` - å·¥å…·åˆ†å±‚è®¾è®¡
- `src/tools/miniprogram.ts` - MiniProgram å·¥å…·ä¾èµ–
- `src/tools/page.ts` - Page å·¥å…·ä¾èµ–
- `src/tools/element.ts` - Element å·¥å…·ä¾èµ–
- `src/core/output.ts` - OutputManager å®ç°
- Playwright Screenshots - æˆªå›¾åŠŸèƒ½å‚è€ƒ

---

**Approval**: âœ… RETROSPECTIVE APPROVED
**Implementation**: âœ… COMPLETED
**Documentation**: â³ IN PROGRESS
